{% extends 'base.html' %}
{% load static %}
{% block content %}
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-6">
                <div class="card card-1">
                    <table class="table table-bordered " style="margin-top: 25px;">
                        <thead class="thead-dark">
                        <h4>Необработанные клиенты</h4>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Имя клиента</th>
                            <th scope="col">Дата</th>
                            <th scope="col">Филиал</th>
                            <th scope="col">Cтатус</th>
                            <th scope="col">Номер Телефона</th>
                            <th scope="col">Консультант</th>
                            <th scope="col">
                                <button type="button" class="btn btn-danger">Удалить</button>
                            </th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        {% for post in posts %}
                                <tr class="call_center_row">
                                    <th scope="row">{{ post.id }}</th>
                                    <td>{{ post.name }}</td>
                                    <td>{{ post.status }}</td>
                                    <td>{{ post.phone_number }}</td>
                                    <td>
                                        <button type="button" class="btn btn-primary" data-toggle="modal" onclick="getInfo({{ post.id }})">
                                            <a id="{{ post.id }}">Инфо</a>
                                        </button>
                                    </td>
                                </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    {% if  post.has_other_pages %}
                        <ul class="pagination">
                            {% if post.has_previous %}
                                <li><a href="?page={{ post.previous_page_number }}">&laquo;</a></li>
                            {% else %}
                                <li class="disabled"><span>&laquo;</span></li>
                            {% endif %}
                            {% for i in post.paginator.page_range %}
                                {% if users.number == i %}
                                    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                                {% elif i > post.number|add:'-5' and i < post.number|add:'5' %}
                                    <li><a href="?page={{ i }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}
                            {% if post.has_next %}
                                <li><a href="?page={{ post.next_page_number }}">&raquo;</a></li>
                            {% else %}
                                <li class="disabled"><span>&raquo;</span></li>
                            {% endif %}
                        </ul>
                    {% endif %}

                </div>
            </div>
            <div class="col-lg-6">
                <div class="card card-1">
                    <table class="table table-bordered " style="margin-top: 25px;">
                        <thead class="thead-dark">
                        <h4>Обработанные клиенты</h4>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Имя клиента</th>
                            <th scope="col">Дата</th>
                            <th scope="col">Время</th>
                            <th scope="col">Филиал</th>
                            <th scope="col">Номер Телефона</th>
                            <th scope="col">Консультант</th>
                            <th scope="col">
                                <button type="button" class="btn btn-danger">Удалить</button>
                            </th>
                        </tr>
                        </thead>
                        <tbody id="tbody">
                        {% for post in call_post %}
                            <tr class="call_center_row">
                                <th scope="row">{{ post.visitor.id }}</th>
                                <td>{{ post.visitor.visitor.name }}</td>
                                <td>{{ post.visitor.date }}</td>
                                <td>{{ post.visitor.filial }}</td>
                                <td>{{ post.visitor.visitor.status }}</td>
                                <td>{{ post.visitor.visitor.phone_number }}</td>
                                <td>{{ post.visitor.consultant }}</td>
                                <td>
                                    <button type="button" class="btn btn-success" data-toggle="modal"
                                    >
                                        <a onclick="getInfo({{ post.visitor.id }})">Изменить</a>
                                    </button>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>

                    {% if  call_post.has_other_pages %}
                        <ul class="pagination">
                            {% if call_post.has_previous %}
                                <li><a href="?page2={{ call_post.previous_page_number }}">&laquo;</a></li>
                            {% else %}
                                <li class="disabled"><span>&laquo;</span></li>
                            {% endif %}
                            {% for i in call_post.paginator.page_range %}
                                {% if users.number == i %}
                                    <li class="active"><span>{{ i }} <span class="sr-only">(current)</span></span></li>
                                {% elif i > call_post.number|add:'-5' and i < call_post.number|add:'5' %}
                                    <li><a href="?page2={{ i }}">{{ i }}</a></li>
                                {% endif %}
                            {% endfor %}
                            {% if call_post.has_next %}
                                <li><a href="?page2={{ call_post.next_page_number }}">&raquo;</a></li>
                            {% else %}
                                <li class="disabled"><span>&raquo;</span></li>
                            {% endif %}
                        </ul>
                    {% endif %}
                </div>
            </div>
        </div>


        <!-- The Modal -->

        <div class="myModal">
            <button class="hide-modal float-right">X</button>
            <div class="data-container">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-6">
                            <ul>
                                <li><span>Имя</span><span id="md-name"></span>
                                </li>
                                <li><span>Номер телефона</span><span id="md-number" class="md-number"></span></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <ul>
                                <li><span>Статус</span><span id="md-status"></span>
                                </li>
                                <li><span>Характер</span><span id="md-character"></span></li>
                            </ul>
                        </div>
                    </div>
                    <div class="customer-info">

                    </div>


                    <form class="call-form" name="editForm" action="{% url 'post_call_content' %}" method="POST">
                        {% csrf_token %}
                        <div class="col-md-12">
                            <!-- Text input-->
                            <div class="form-group">
                                <label class="control-label" for="textinput">Информация</label>
                                <input id="textinput" name="call_content" type="text" placeholder=""
                                       class="form-control input-md">
                                <input type="hidden" name="id" value="" class="ci_id">
                            </div>
                            <div class="s-button">
                                <input id="submit-btn" type="submit" name="call_id" class="btn btn-success"
                                       value="Отправить">
                            </div>
                        </div>
                    </form>
                </div>
            </div>


        </div>
    </div>

    {% block script %}
        <script>
            function getInfo(id) {
                $('#call_content_tf').text('');
                console.log("working");

                function httpGet(url) {

                    return new Promise(function (resolve, reject) {

                        var xhr = new XMLHttpRequest();
                        xhr.open('GET', url, true);

                        xhr.onload = function () {
                            if (this.status == 200) {
                                resolve(this.response);
                            } else {
                                var error = new Error(this.statusText);
                                error.code = this.status;
                                reject(error);
                            }
                        };

                        xhr.onerror = function () {
                            reject(new Error("Network Error"));
                        };

                        xhr.send();
                    });

                }

                httpGet('/api/customer/' + id)
                    .then(response => {
                        let res = JSON.parse(response);
                        console.log(res);
                        console.log("ci_id" + res.id);
                        $('.ci_id').val(res.id);
                        $(".customer-info").text('');
                        res.visitors.length
                        $('#md-name').text(res.name);
                        $('#md-number').text(res.phone_number);
                        $('#md-character').text(res.character);
                        $('#md-status').text(res.status);
                        $('#md-nuance').text(res.nuance);
                        for (i = 0; i < res.visitors.length; i++)
                            $(".customer-info").append('                      <p><span>Дата</span> <span id="data-a">' + res.visitors[i].date + '</span></p>\n' +
                                '                    <div class="row">\n' +
                                '                        <div class="col-md-4">\n' +
                                '                            <ul>\n' +
                                '                                <li><span>Нюансы</span> <span id="md-nuance">' + res.nuance + '</span>\n' +
                                '                                </li>\n' +
                                '                                <li><span>Категория</span> <span id="md-category">' + res.visitors[i].category[0].name + '</span>\n' +
                                '                                </li>\n' +
                                '                                <li><span>Наименование</span> <span id="md-title">' + res.visitors[i].name_furniture + '</span>\n' +
                                '                                </li>\n' +
                                '                            </ul>\n' +
                                '\n' +
                                '                        </div>\n' +
                                '                        <div class="col-md-4">\n' +
                                '                            <ul>\n' +
                                '                                <li><span>Тип мебели</span><span id="md-type">' + res.visitors[0].type_furniture + '</span></li>\n' +
                                '                                <li><span>Модель мебели</span><span id="md-model">' + res.visitors[0].model_furniture + '</span>\n' +
                                '                                </li>\n' +
                                '                                <li><span>Цвет</span><span id="md-color">' + res.visitors[0].color + '</span></li>\n' +
                                '\n' +
                                '\n' +
                                '                        </div>\n' +
                                '                        <div class="col-md-4">\n' +
                                '                            <ul>\n' +
                                '                                <li><span>Другие магазины</span><span id="md-magazin">' + res.visitors[0].filial.name + '</span></li>\n' +
                                '                                <li><span>Консултант</span> <span id="md-consultant">' + res.visitors[0].other_shop + '</span></li>\n' +
                                '                                <li><span>Филиал</span><span id="md-filial">' + res.visitors[0].filial.name + '</span></li>\n' +
                                '                            </ul>\n' +
                                '                            </ul>\n' +
                                '                        </div>\n' +
                                '                    </div>\n' +
                                '                    <p><span>Дата</span>' + res.visitors[i].date + ' <span id="data-a"></span></p>\n' +
                                '                    <div class="row">\n' +
                                '                        <div class="col-md-3">\n' +
                                '                            <ul>\n' +
                                '                                <li><span id="md-call-center-name" style="color: black">Хамида</span></li>\n' +
                                '                            </ul>\n' +
                                '\n' +
                                '                        </div>\n' +
                                '                        <div class="col-md-9">\n' +
                                '                            <ul>\n' +
                                '                                <li><span>Контент разговора</span></li>\n' +
                                '                                <textfield id="call_content_tf"></textfield>\n' +
                                '\n' +
                                '                            </ul>\n' +
                                '\n' +
                                '\n' +
                                '                        </div>\n' +
                                '                    </div>\n');


                        {#$('#data-a').text(res.visitors[0].date);#}
                        {#$('#md-category').text(res.visitors[0].category[0].name);#}
                        {#$('#md-title').text(res.visitors[0].name_furniture);#}
                        {#$('#md-type').text(res.visitors[0].type_furniture);#}
                        {#$('#md-model').text(res.visitors[0].model_furniture);#}
                        {#$('#md-color').text(res.visitors[0].color);#}
                        {#$('#md-filial').text(res.visitors[0].filial.name);#}
                        {#$('#md-magazin').text(res.visitors[0].other_shop);#}
                        {#$('#md-consultant').text(res.visitors[0].consultant.name);#}
                        {#if (res.visitors[0].callers.length > 0) {#}
                        {#    $('#call_content_tf').text(res.visitors[0].callers[0].call_content);#}


                        $('.myModal').show();

                    });
            }

            $(".hide-modal").click(function (e) {
                $(".myModal").hide();
            })


        </script>

    {% endblock %}

    </div>
{% endblock %}